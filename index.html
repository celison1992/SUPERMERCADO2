<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Contatos Dinâmico - Firebase</title>
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; padding: 20px; }
        input[type="text"], input[type="email"], select { 
            width: 300px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            box-sizing: border-box; 
        }
        button { 
            padding: 10px 15px; background-color: #007bff; color: white; border: none; 
            cursor: pointer; border-radius: 4px; margin-right: 10px; 
        }
        button:hover { background-color: #0056b3; }
        hr { margin: 30px 0; border: 0; border-top: 1px solid #eee; }

        /* Estilos de Seção */
        .secao { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .secao h3 { margin-top: 0; }
        
        /* Estilos para a Tabela */
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* O container da lista estará oculto por padrão */
        #listaContatosContainer {
            margin-top: 30px;
            padding-top: 15px;
            display: none; 
        }
    </style>
</head>
<body>
    <h1>Sistema de Contatos</h1>

    <div class="secao">
        <h3>1. Cadastrar Novo Nome (Preenche a lista de seleção)</h3>
        <form id="catalogoForm" onsubmit="return salvarNovoNome()">
            <label for="novoNome">Nome para o Catálogo:</label><br>
            <input type="text" id="novoNome" required><br>
            <button type="submit">Adicionar ao Catálogo</button>
            <p style="font-size: 0.9em; color: #666;">O nome adicionado aparecerá na lista de seleção abaixo.</p>
        </form>
    </div>

    <hr>
    
    <div class="secao">
        <h3>2. Cadastro de Contato</h3>
        <form id="contatoForm" onsubmit="return salvarContato()">
            
            <label for="nomeSelect">Nome:</label><br>
            <select id="nomeSelect" name="nomeSelect" required>
                <option value="" disabled selected>Carregando catálogo...</option>
            </select><br><br>

            <label for="email">Email:</label><br>
            <input type="email" id="email" name="email" required><br><br>

            <button type="submit">Salvar Contato</button>
        </form>
    </div>

    <hr>
    
    <button onclick="mostrarLista()">Ver Contatos Cadastrados</button>

    <div id="listaContatosContainer">
        <h3>Contatos Salvos (Tempo Real)</h3>
        <div id="listaContatos">
            <p>Carregando...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // 1. CONFIGURAÇÃO DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAHb0R-Q2ycvrmSb3TBv01ttIWd7pMOaFE",
            authDomain: "supermercado2-2170d.firebaseapp.com",
            projectId: "supermercado2-2170d",
            storageBucket: "supermercado2-2170d.firebasestorage.app",
            messagingSenderId: "309197163875",
            appId: "1:309197163875:web:ca8f836c3a69bc710d1756",
            measurementId: "G-F9K74XEXR1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let isContatosListenerActive = false; 
        
        // Nomes das coleções no Firestore
        const COLECAO_CATALOGO = "usuarios_catalogo"; 
        const COLECAO_CONTATOS = "contatos_salvos"; 


        // 2. FUNÇÃO PARA CADASTRAR UM NOVO NOME (Catalogo)
        window.salvarNovoNome = async function() {
            const nomeUsuario = document.getElementById("novoNome").value.trim();

            if (nomeUsuario === "") {
                alert("O nome para o catálogo não pode ser vazio.");
                return false;
            }

            const dadosCatalogo = {
                nome: nomeUsuario,
                criado_em: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLECAO_CATALOGO), dadosCatalogo);
                
                alert(`Nome "${nomeUsuario}" adicionado ao catálogo!`);
                document.getElementById("catalogoForm").reset();

            } catch (error) {
                console.error("Erro ao adicionar nome ao catálogo: ", error);
                alert("FALHA ao salvar o catálogo. Verifique o console.");
            }

            return false;
        }


        // 3. FUNÇÃO PARA SALVAR O CONTATO (Usa Select e Email)
        window.salvarContato = async function() {
            const nome = document.getElementById("nomeSelect").value.trim(); 
            const email = document.getElementById("email").value.trim();

            if (nome === "" || email === "") {
                alert("Por favor, selecione um Nome e insira um Email.");
                return false;
            }

            const dadosContato = {
                nome: nome,
                email: email,
                data_cadastro: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLECAO_CONTATOS), dadosContato);
                
                alert(`SUCESSO! Contato de '${nome}' (${email}) salvo.`);
                document.getElementById("contatoForm").reset();

            } catch (error) {
                console.error("Erro ao salvar contato: ", error);
                alert("FALHA ao salvar.");
            }

            return false;
        }


        // 4. FUNÇÃO PARA PREENCHER O SELECT (onSnapshot no Catálogo)
        function carregarCatalogo() {
            const selectElement = document.getElementById('nomeSelect');
            const colecaoRef = collection(db, COLECAO_CATALOGO);
            
            const q = query(colecaoRef, orderBy("nome", "asc"));

            onSnapshot(q, (querySnapshot) => {
                let optionsHtml = '<option value="" disabled selected>Selecione um Nome</option>';
                
                if (querySnapshot.empty) {
                     optionsHtml += '<option value="" disabled>Nenhum nome cadastrado no catálogo.</option>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        optionsHtml += `<option value="${item.nome}">${item.nome}</option>`;
                    });
                }
                
                selectElement.innerHTML = optionsHtml;

            }, (error) => {
                console.error("Erro ao carregar catálogo: ", error);
                selectElement.innerHTML = '<option value="" disabled selected>Erro ao carregar catálogo</option>';
            });
        }
        
        
        // 5. FUNÇÃO PARA MOSTRAR A LISTA (Ativa o ouvinte principal)
        window.mostrarLista = function() {
            document.getElementById('listaContatosContainer').style.display = 'block';

            if (!isContatosListenerActive) {
                carregarContatosEmTempoReal();
                isContatosListenerActive = true;
            }
        }
        
        
        // 6. FUNÇÃO DE LEITURA EM TEMPO REAL DOS CONTATOS SALVOS
        function carregarContatosEmTempoReal() {
            const listaDiv = document.getElementById('listaContatos');
            const colecaoRef = collection(db, COLECAO_CONTATOS);
            
            const q = query(colecaoRef, orderBy("data_cadastro", "desc"));

            onSnapshot(q, (querySnapshot) => {
                let htmlTabela = '<table><thead><tr><th>Nome</th><th>Email</th><th>Data do Cadastro</th></tr></thead><tbody>';
                
                if (querySnapshot.empty) {
                     listaDiv.innerHTML = '<p>Nenhum contato registrado ainda.</p>';
                     return;
                }

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    
                    const data = item.data_cadastro ? 
                                 new Date(item.data_cadastro.toDate()).toLocaleString('pt-BR') : 
                                 'Aguardando...';

                    htmlTabela += `
                        <tr>
                            <td>${item.nome}</td>
                            <td>${item.email}</td>
                            <td>${data}</td>
                        </tr>
                    `;
                });

                htmlTabela += '</tbody></table>';
                
                listaDiv.innerHTML = htmlTabela;

            }, (error) => {
                console.error("Erro ao receber atualização em tempo real: ", error);
                listaDiv.innerHTML = '<p style="color: red;">Erro ao carregar contatos. Verifique as Regras de Segurança do Firestore.</p>';
            });
        }

        // 7. INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', carregarCatalogo);

    </script>
</body>
</html>
