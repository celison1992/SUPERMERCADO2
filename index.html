<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Estoque Dinâmico - Firebase</title>
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; padding: 20px; }
        input[type="text"], input[type="number"], select { 
            width: 300px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            box-sizing: border-box; 
        }
        button { 
            padding: 10px 15px; background-color: #007bff; color: white; border: none; 
            cursor: pointer; border-radius: 4px; margin-right: 10px; 
        }
        button:hover { background-color: #0056b3; }
        hr { margin: 30px 0; border: 0; border-top: 1px solid #eee; }

        /* Estilos de Seção */
        .secao { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .secao h3 { margin-top: 0; }
        
        /* Estilos para a Tabela */
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* O container da lista estará oculto por padrão */
        #listaEstoqueContainer {
            margin-top: 30px;
            padding-top: 15px;
            display: none; 
        }
    </style>
</head>
<body>
    <h1>Sistema de Estoque</h1>

    <div class="secao">
        <h3>1. Cadastrar Novo Produto (Item de Catálogo)</h3>
        <form id="catalogoForm" onsubmit="return salvarNovoProduto()">
            <label for="novoProdutoNome">Nome do Produto:</label><br>
            <input type="text" id="novoProdutoNome" required><br>
            <button type="submit">Adicionar ao Catálogo</button>
            <p style="font-size: 0.9em; color: #666;">O nome adicionado aparecerá na lista de seleção abaixo.</p>
        </form>
    </div>

    <hr>
    
    <div class="secao">
        <h3>2. Lançamento de Entrada de Estoque</h3>
        <form id="estoqueForm" onsubmit="return salvarLancamentoEstoque()">
            
            <label for="produtoSelect">Produto:</label><br>
            <select id="produtoSelect" name="produtoSelect" required>
                <option value="" disabled selected>Carregando catálogo...</option>
            </select><br><br>

            <label for="quantidade">Quantidade:</label><br>
            <input type="number" id="quantidade" name="quantidade" required min="1"><br><br>

            <button type="submit">Salvar Lançamento</button>
        </form>
    </div>

    <hr>
    
    <button onclick="mostrarLista()">Ver Lançamentos de Estoque</button>

    <div id="listaEstoqueContainer">
        <h3>Histórico de Lançamentos (Tempo Real)</h3>
        <div id="listaLancamentos">
            <p>Carregando...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // 1. CONFIGURAÇÃO DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            // VERIFIQUE SE SUAS CREDENCIAIS ESTÃO CORRETAS AQUI
            apiKey: "AIzaSyAHb0R-Q2ycvrmSb3TBv01ttIWd7pMOaFE",
            authDomain: "supermercado2-2170d.firebaseapp.com",
            projectId: "supermercado2-2170d",
            storageBucket: "supermercado2-2170d.firebasestorage.app",
            messagingSenderId: "309197163875",
            appId: "1:309197163875:web:ca8f836c3a69bc710d1756",
            measurementId: "G-F9K74XEXR1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let isLancamentosListenerActive = false; 
        
        // Nomes das coleções no Firestore
        const COLECAO_CATALOGO = "produtos_catalogo"; 
        const COLECAO_LANCAMENTOS = "lancamentos_estoque"; 


        // 2. FUNÇÃO PARA CADASTRAR UM NOVO PRODUTO NO CATÁLOGO
        window.salvarNovoProduto = async function() {
            const nomeProduto = document.getElementById("novoProdutoNome").value.trim();

            if (nomeProduto === "") {
                alert("O nome do produto não pode ser vazio.");
                return false;
            }

            const dadosCatalogo = {
                nome: nomeProduto,
                criado_em: serverTimestamp()
            };

            try {
                // Salva na coleção 'produtos_catalogo'
                await addDoc(collection(db, COLECAO_CATALOGO), dadosCatalogo);
                
                alert(`Produto "${nomeProduto}" adicionado ao catálogo!`);
                document.getElementById("catalogoForm").reset();

            } catch (error) {
                console.error("Erro ao adicionar produto ao catálogo: ", error);
                alert("FALHA ao salvar o catálogo. Verifique o Console e Regras de Segurança.");
            }

            return false;
        }


        // 3. FUNÇÃO PARA SALVAR O LANÇAMENTO (Usa Select do Produto e Quantidade)
        window.salvarLancamentoEstoque = async function() {
            const produto = document.getElementById("produtoSelect").value.trim(); 
            const quantidade = parseInt(document.getElementById("quantidade").value.trim());

            if (produto === "" || isNaN(quantidade) || quantidade < 1) {
                alert("Por favor, selecione um Produto e insira uma Quantidade válida (maior que zero).");
                return false;
            }

            const dadosEstoque = {
                produto: produto,
                quantidade: quantidade, 
                data_lancamento: serverTimestamp()
            };

            try {
                // Salva na coleção 'lancamentos_estoque'
                await addDoc(collection(db, COLECAO_LANCAMENTOS), dadosEstoque);
                
                alert(`SUCESSO! Lançamento de ${quantidade} unidades de '${produto}' salvo.`);
                document.getElementById("estoqueForm").reset();

            } catch (error) {
                console.error("Erro ao salvar lançamento: ", error);
                alert("FALHA ao salvar.");
            }

            return false;
        }


        // 4. FUNÇÃO PARA PREENCHER O SELECT DO CATÁLOGO (CHAVE PARA O DROPDOWN)
        function carregarCatalogo() {
            const selectElement = document.getElementById('produtoSelect');
            const colecaoRef = collection(db, COLECAO_CATALOGO);
            
            const q = query(colecaoRef, orderBy("nome", "asc"));

            onSnapshot(q, (querySnapshot) => {
                let optionsHtml = '<option value="" disabled selected>Selecione um Produto</option>';
                
                if (querySnapshot.empty) {
                     optionsHtml += '<option value="" disabled>Nenhum produto cadastrado no catálogo.</option>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        optionsHtml += `<option value="${item.nome}">${item.nome}</option>`;
                    });
                }
                
                selectElement.innerHTML = optionsHtml;

            }, (error) => {
                console.error("Erro ao carregar catálogo: ", error);
                selectElement.innerHTML = '<option value="" disabled selected>Erro ao carregar catálogo</option>';
            });
        }
        
        
        // 5. FUNÇÃO PARA MOSTRAR A LISTA DE LANÇAMENTOS
        window.mostrarLista = function() {
            document.getElementById('listaEstoqueContainer').style.display = 'block';

            if (!isLancamentosListenerActive) {
                carregarLancamentosEmTempoReal();
                isLancamentosListenerActive = true;
            }
        }
        
        
        // 6. FUNÇÃO DE LEITURA EM TEMPO REAL DOS LANÇAMENTOS
        function carregarLancamentosEmTempoReal() {
            const listaDiv = document.getElementById('listaLancamentos');
            const colecaoRef = collection(db, COLECAO_LANCAMENTOS);
            
            const q = query(colecaoRef, orderBy("data_lancamento", "desc"));

            onSnapshot(q, (querySnapshot) => {
                let htmlTabela = '<table><thead><tr><th>Produto</th><th>Quantidade</th><th>Data do Lançamento</th></tr></thead><tbody>';
                
                if (querySnapshot.empty) {
                     listaDiv.innerHTML = '<p>Nenhum lançamento de estoque registrado ainda.</p>';
                     return;
                }

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    
                    const data = item.data_lancamento ? 
                                 new Date(item.data_lancamento.toDate()).toLocaleString('pt-BR') : 
                                 'Aguardando...';

                    htmlTabela += `
                        <tr>
                            <td>${item.produto}</td>
                            <td>${item.quantidade}</td> 
                            <td>${data}</td>
                        </tr>
                    `;
                });

                htmlTabela += '</tbody></table>';
                
                listaDiv.innerHTML = htmlTabela;

            }, (error) => {
                console.error("Erro ao receber atualização em tempo real: ", error);
                listaDiv.innerHTML = '<p style="color: red;">Erro ao carregar lançamentos. Verifique as Regras de Segurança do Firestore.</p>';
            });
        }

        // 7. INICIALIZAÇÃO: Carrega o catálogo assim que a página é aberta
        document.addEventListener('DOMContentLoaded', carregarCatalogo);

    </script>
</body>
</html>
