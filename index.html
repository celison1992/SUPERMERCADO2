<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    updateDoc,
    deleteDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";

  // üîÑ Nova configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAHb0R-Q2ycvrmSb3TBv01ttIWd7pMOaFE",
    authDomain: "supermercado2-2170d.firebaseapp.com",
    projectId: "supermercado2-2170d",
    storageBucket: "supermercado2-2170d.firebasestorage.app",
    messagingSenderId: "309197163875",
    appId: "1:309197163875:web:5d53fb08bf34f6be0d1756",
    measurementId: "G-TBYLX75XLM"
  };

  // üîß Inicializa√ß√£o do Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  const colecao = collection(db, "supermercado");
  let mercados = [];

  // üîÑ Fun√ß√µes mantidas (carregar, cadastrar, editar, excluir, etc.)
  async function carregarMercados() {
    const snapshot = await getDocs(colecao);
    mercados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    atualizarLista();
  }

  async function cadastrarMercado() {
    const nome = document.getElementById('nomeMercado').value.trim().toUpperCase();
    const tipo = document.getElementById('tipoLogradouro').value.trim().toUpperCase();
    const rua = document.getElementById('ruaMercado').value.trim().toUpperCase();
    const bairro = document.getElementById('bairroMercado').value.trim().toUpperCase();

    if (!nome || !tipo || !rua || !bairro) {
      alert('Preencha todos os campos.');
      return;
    }

    const endereco = `${tipo} ${rua}, BAIRRO ${bairro}`;
    const existe = mercados.some(m => m.nome === nome && m.endereco === endereco);
    if (existe) {
      alert('Este supermercado j√° est√° cadastrado.');
      return;
    }

    try {
      await addDoc(colecao, { nome, endereco });
      await carregarMercados();
      limparCampos();
      alert('Supermercado cadastrado com sucesso!');
    } catch (error) {
      console.error("Erro ao salvar:", error);
      alert("Erro ao salvar no Firebase.");
    }
  }

  function atualizarLista() {
    const select = document.getElementById('selectMercado');
    const ul = document.getElementById('listaMercados');
    select.innerHTML = '';
    ul.innerHTML = '';

    mercados.forEach((m, i) => {
      const option = document.createElement('option');
      option.value = i;
      option.text = `${m.nome} ‚Äî ${m.endereco}`;
      select.appendChild(option);

      const tipo = m.endereco.split(',')[0].split(' ')[0];
      const rua = m.endereco.split(',')[0].split(' ').slice(1).join(' ');
      const bairro = m.endereco.split(',')[1].replace(' BAIRRO ', '').trim();

      const li = document.createElement('li');
      li.innerHTML = `
        <input type="text" value="${m.nome}" onchange="editarCampo(${i}, 'nome', this.value)" style="width:150px">
        <input type="text" value="${tipo}" onchange="editarCampo(${i}, 'tipo', this.value)" style="width:80px">
        <input type="text" value="${rua}" onchange="editarCampo(${i}, 'rua', this.value)" style="width:120px">
        <input type="text" value="${bairro}" onchange="editarCampo(${i}, 'bairro', this.value)" style="width:100px">
        <button onclick="excluirMercado(${i})">üóëÔ∏è</button>
      `;
      ul.appendChild(li);
    });
  }

  async function editarCampo(index, campo, valor) {
    valor = valor.toUpperCase();
    const mercado = mercados[index];
    const partes = mercado.endereco.split(',')[0].split(' ');
    let tipo = partes[0];
    let rua = partes.slice(1).join(' ');
    let bairro = mercado.endereco.split(',')[1].replace(' BAIRRO ', '').trim();

    if (campo === 'nome') {
      mercado.nome = valor;
    } else if (campo === 'tipo') {
      tipo = valor;
    } else if (campo === 'rua') {
      rua = valor;
    } else if (campo === 'bairro') {
      bairro = valor;
    }

    mercado.endereco = `${tipo} ${rua}, BAIRRO ${bairro}`;

    try {
      await updateDoc(doc(db, "supermercado", mercado.id), {
        nome: mercado.nome,
        endereco: mercado.endereco
      });
      await carregarMercados();
    } catch (error) {
      console.error("Erro ao editar:", error);
      alert("Erro ao editar no Firebase.");
    }
  }

  async function excluirMercado(index) {
    if (confirm('Deseja excluir este supermercado?')) {
      try {
        await deleteDoc(doc(db, "supermercado", mercados[index].id));
        await carregarMercados();
        limparCampos();
      } catch (error) {
        console.error("Erro ao excluir:", error);
        alert("Erro ao excluir no Firebase.");
      }
    }
  }

  function limparCampos() {
    document.getElementById('nomeMercado').value = '';
    document.getElementById('tipoLogradouro').value = '';
    document.getElementById('ruaMercado').value = '';
    document.getElementById('bairroMercado').value = '';
    document.getElementById('btnCadastrar').textContent = 'Cadastrar';
  }

  carregarMercados();
</script>
