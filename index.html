<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro Simples de Estoque com Tabela</title>
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; padding: 20px; }
        input[type="text"], input[type="number"] { 
            width: 300px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; 
            box-sizing: border-box; 
        }
        button { 
            padding: 10px 15px; background-color: #007bff; color: white; border: none; 
            cursor: pointer; border-radius: 4px; margin-right: 10px; 
        }
        button:hover { background-color: #0056b3; }
        hr { margin: 30px 0; border: 0; border-top: 1px solid #eee; }

        /* Estilos de Seção */
        .secao { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .secao h3 { margin-top: 0; }
        
        /* Estilos para a Tabela */
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* O container da lista estará oculto por padrão */
        #listaEstoqueContainer {
            margin-top: 30px;
            padding-top: 15px;
            display: none; 
        }
    </style>
</head>
<body>
    <h1>Lançamento de Estoque</h1>

    <div class="secao">
        <h3>Cadastro de Entrada de Estoque</h3>
        <form id="estoqueForm" onsubmit="return salvarLancamentoEstoque()">
            
            <label for="produto">Produto:</label><br>
            <input type="text" id="produto" name="produto" required><br><br>

            <label for="quantidade">Quantidade:</label><br>
            <input type="number" id="quantidade" name="quantidade" required min="1"><br><br>

            <button type="submit">Salvar Lançamento</button>
        </form>
    </div>

    <hr>
    
    <button onclick="mostrarLista()">Ver Histórico de Lançamentos</button>

    <div id="listaEstoqueContainer">
        <h3>Histórico de Lançamentos (Atualização em Tempo Real)</h3>
        <div id="listaLancamentos">
            <p>Carregando...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // 1. CONFIGURAÇÃO DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            // MANTENHA SUAS CREDENCIAIS AQUI
            apiKey: "AIzaSyAHb0R-Q2ycvrmSb3TBv01ttIWd7pMOaFE",
            authDomain: "supermercado2-2170d.firebaseapp.com",
            projectId: "supermercado2-2170d",
            storageBucket: "supermercado2-2170d.firebasestorage.app",
            messagingSenderId: "309197163875",
            appId: "1:309197163875:web:ca8f836c3a69bc710d1756",
            measurementId: "G-F9K74XEXR1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let isLancamentosListenerActive = false; 
        
        // ÚNICA COLEÇÃO UTILIZADA
        const COLECAO_LANCAMENTOS = "lancamentos_estoque"; 


        // 2. FUNÇÃO PARA SALVAR O LANÇAMENTO
        window.salvarLancamentoEstoque = async function() {
            // Pega o valor do campo de texto
            const produto = document.getElementById("produto").value.trim(); 
            const quantidade = parseInt(document.getElementById("quantidade").value.trim());

            if (produto === "" || isNaN(quantidade) || quantidade < 1) {
                alert("Por favor, preencha o Produto e a Quantidade válida (maior que zero).");
                return false;
            }

            const dadosEstoque = {
                produto: produto,
                quantidade: quantidade, 
                data_lancamento: serverTimestamp()
            };

            try {
                await addDoc(collection(db, COLECAO_LANCAMENTOS), dadosEstoque);
                
                alert(`SUCESSO! Lançamento de ${quantidade} unidades de '${produto}' salvo.`);
                document.getElementById("estoqueForm").reset();

            } catch (error) {
                console.error("Erro ao salvar lançamento: ", error);
                alert("FALHA ao salvar. Verifique as Regras de Segurança do Firestore.");
            }

            return false;
        }

        
        // 3. FUNÇÃO PARA MOSTRAR A LISTA/TABELA
        window.mostrarLista = function() {
            document.getElementById('listaEstoqueContainer').style.display = 'block';

            if (!isLancamentosListenerActive) {
                carregarLancamentosEmTempoReal();
                isLancamentosListenerActive = true;
            }
        }
        
        
        // 4. FUNÇÃO DE LEITURA EM TEMPO REAL E EXIBIÇÃO NA TABELA
        function carregarLancamentosEmTempoReal() {
            const listaDiv = document.getElementById('listaLancamentos');
            const colecaoRef = collection(db, COLECAO_LANCAMENTOS);
            
            const q = query(colecaoRef, orderBy("data_lancamento", "desc"));

            onSnapshot(q, (querySnapshot) => {
                let htmlTabela = '<table><thead><tr><th>Produto</th><th>Quantidade</th><th>Data do Lançamento</th></tr></thead><tbody>';
                
                if (querySnapshot.empty) {
                     listaDiv.innerHTML = '<p>Nenhum lançamento de estoque registrado ainda.</p>';
                     return;
                }

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    
                    const data = item.data_lancamento ? 
                                 new Date(item.data_lancamento.toDate()).toLocaleString('pt-BR') : 
                                 'Aguardando...';

                    htmlTabela += `
                        <tr>
                            <td>${item.produto}</td>
                            <td>${item.quantidade}</td> 
                            <td>${data}</td>
                        </tr>
                    `;
                });

                htmlTabela += '</tbody></table>';
                
                listaDiv.innerHTML = htmlTabela;

            }, (error) => {
                console.error("Erro ao receber atualização em tempo real: ", error);
                listaDiv.innerHTML = '<p style="color: red;">Erro ao carregar lançamentos. Verifique as Regras de Segurança do Firestore.</p>';
            });
        }
    </script>
</body>
</html>
